#!/usr/bin/env python

# Program: inkscape2latex-ng
# Author: Pierre Ayoub
# Date: 2025-09-19
# Template UUID: b4b9d863-051e-494d-a98b-22b9d0ee4727

from os import path
import sys
import argparse
import logging
import tomllib
import subprocess

LOGGER = None

class InkscapeExporterConfig():
    """Configuration for a `InkscapeExporter`.

    This can be configured from command-line or a sidecar TOML file on-disk.

    """
    # Constants ================================================================

    # Export all the area defining the page.
    INKSCAPE_OPT_AREA = "--export-area-page"
    # Export in PDF rather than EPS.
    INKSCAPE_OPT_TYPE = "--export-type=pdf"
    # Export with sidecar `pdf_tex` file such that LaTeX will render fonts during compilation.
    INKSCAPE_OPT_FONTS_LATEX = "--export-latex"
    # Export in current working directroy by default.
    OUTPUT_DIR_DEFAULT = "."
    # Templates for output file based on exportation mode.
    OUTPUT_FILE_FULL_TEMPLATE = "{}.pdf"
    OUTPUT_FILE_FRAGMENTS_TEMPLATE = "{}@{}.pdf"
    # Let Inkscape render fonts by default.
    FONTS_ENGINE_DEFAULT = "inkscape"
    # By default, performs a full exportation instead of fragments
    FRAGMENTS_DEFAULT = False

    # Runtime variables ========================================================

    # Input SVG file to export [string]
    input_file = None
    # Basename of input file (without leading directories and extension) [string]
    input_file_basename = None
    # Output directory for exportation [string]
    output_dir = OUTPUT_DIR_DEFAULT

    # Common dictionary to command-line and TOML file.
    config_dict = {
        "params": {
            # Define which from Inkscape or LaTeX will render the fonts ["latex" | "inkscape"]
            "fonts_engine": FONTS_ENGINE_DEFAULT,
            # Flag enabling fragments exportation instead of full exportation [bool]
            "fragments": FRAGMENTS_DEFAULT,
        },
        # Defines series of fragments exportation
        # [{"name": "NAME", "excluded_id": ["step1", "step3", "step3"]}]
        "fragments": None,
    }

    # Methods ==================================================================

    def __init__(self, input_file):
        """Initialize an exporter configuration with an input file and default values."""
        # Get an input file
        self.input_file = input_file
        # Derive basename
        self.input_file_basename = path.splitext(path.basename(self.input_file))[0]

    def load_toml(self):
        """Load a configuration from a sidecar TOML file."""
        # If found a corresponding TOML file, load it.
        config_file_name = self.input_file.replace(".svg", ".toml")
        if path.exists(config_file_name):
            LOGGER.debug("Loading configuration from: {}".format(config_file_name))
            with open(config_file_name, "rb") as f:
                config_file_content = tomllib.load(f)
        # Otherwise, silently ignore.
        else:
            return
        # Update object configuration from the TOML configuration
        self.config_dict.update(config_file_content)

    def load_args(self, output_dir=None, fonts_engine=None, fragments=None):
        """Load configuration from arguments. 

        Purpose is to configure manually for testing purpose or overriding after loading from a TOML file.

        """
        LOGGER.debug("Loading configuration from: {}".format(sys.argv))
        if output_dir is not None:
            self.output_dir = output_dir
        if fonts_engine is not None:
            self.config_dict["params"]["fonts_engine"] = fonts_engine
        if fragments is not None:
            self.config_dict["params"]["fragments"] = fragments

    def __str__(self):
        """Return a textual representation of the current configuration"""
        return "\n[v] input_file={}\n[v] output_dir={}\n[v] config_dict={}".format(
            self.input_file,
            self.output_dir,
            self.config_dict
        )


class InkscapeExporter():
    """Inkscape Exporter configurable through InkscapeExporterConfig."""

    # Configuration [InkscapeExporterConfig]
    config = None

    def __init__(self, config):
        assert type(config) == InkscapeExporterConfig
        # Get the configuration
        self.config = config

    def run(self):
        """Run the exportation based on registered config"""
        LOGGER.info("Run exportation: {}".format(self.config.input_file))
        if not self.config.config_dict["params"]["fragments"]:
            self._export_full()   
        else:
            self._export_fragments()

    def _export_full(self):
        """Export an Inkscape SVG in full mode"""
        # Build exportation option string based on configuration
        inkscape_opts = [InkscapeExporterConfig.INKSCAPE_OPT_AREA, InkscapeExporterConfig.INKSCAPE_OPT_TYPE]
        if self.config.config_dict["params"]["fonts_engine"] == "latex":
            inkscape_opts += [InkscapeExporterConfig.INKSCAPE_OPT_FONTS_LATEX]
        # Build output filename
        output_file = "{}/{}".format(
            self.config.output_dir,
            InkscapeExporterConfig.OUTPUT_FILE_FULL_TEMPLATE.format(self.config.input_file_basename)
        )
        # Build command-line
        cmdline = ["inkscape"] + inkscape_opts + ["--export-filename={}".format(output_file), self.config.input_file]
        # Run the exportation
        LOGGER.debug("Run: {}".format(cmdline))
        subprocess.run(cmdline)

    def _export_fragments(self):
        """Export an Inkscape SVG in fragments mode"""
        # Build exportation option string based on configuration
        inkscape_opts = [InkscapeExporterConfig.INKSCAPE_OPT_AREA, InkscapeExporterConfig.INKSCAPE_OPT_TYPE]
        # Iterate over all fragments
        for fragment in self.config.config_dict["fragments"]:
            # Build output filename
            output_file = "{}/{}".format(
                self.config.output_dir,
                InkscapeExporterConfig.OUTPUT_FILE_FRAGMENTS_TEMPLATE.format(
                    self.config.input_file_basename,
                    fragment)
            )
            # Get layers that should be excluded from current fragment
            excluded_layers = self.config.config_dict["fragments"][fragment]["excluded_layers"]
            # Based on that list, build the Inkscape actions that should be used to exclude those layers
            if len(excluded_layers) >= 1:
                inkscape_actions = ["--actions=select-by-id:{};delete-selection;export-do".format(",".join(excluded_layers))]
            else:
                inkscape_actions = []
            # Build final command-line
            cmdline = ["inkscape"] \
                + inkscape_opts \
                + inkscape_actions \
                + ["--export-filename={}".format(output_file), self.config.input_file]
            # Run the exportation
            LOGGER.debug("Run: {}".format(cmdline))
            subprocess.run(cmdline)

class Inkscape2LaTeXLogger():
    """Logger for Inkscape2LaTeX."""

    FMT_INFO = "[%(levelname)s] %(name)s: %(message)s"
    FMT_DEBUG = "[%(levelname)s] %(name)s.%(module)s: %(message)s"

    def __init__(self, level):
        assert level in [logging.INFO, logging.DEBUG]
        # Create the logger
        self.logger = logging.getLogger('inkscape2latex')
        self.logger.setLevel(level)

        # Create console handler and set level to debug
        self.handler = logging.StreamHandler()
        self.handler.setLevel(level)

        # Create formatter
        if level == logging.INFO:
            fmt = Inkscape2LaTeXLogger.FMT_INFO
        elif level == logging.DEBUG:
            fmt = Inkscape2LaTeXLogger.FMT_DEBUG
        else:
            fmt = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        self.formatter = logging.Formatter(fmt)

        # Connect everything
        self.handler.setFormatter(self.formatter)
        self.logger.addHandler(self.handler)

class Inkscape2LaTeXCLI:
    """Command-line interface for Inkscape2LaTeX."""

    def __init__(self):
        """Initialize command-line interface."""
        global LOGGER

        # Command-line interface ===============================================

        parser = argparse.ArgumentParser(
            prog='inkscape2latex',
            description='TODO'
        )

        parser.add_argument('FILE', help="Inkscape drawing in SVG format to export", type=str)

        parser.add_argument('-v', '--verbose', default=False, action="store_true",
                            help="Increase verbosity if set")
        parser.add_argument("-o", "--output-dir", type=str, default=None,
                            help="Set the output directory [default = {}]".format(InkscapeExporterConfig.OUTPUT_DIR_DEFAULT))
        parser.add_argument("--fonts-engine", type=str, choices=["latex", "inkscape"], default=None,
                            help="Set the font rendering engine [default = {}]".format(InkscapeExporterConfig.FONTS_ENGINE_DEFAULT))
        parser.add_argument("--fragments", action=argparse.BooleanOptionalAction, default=None,
                            help="Enable (or disable) fragments exportation (instead of full exportation) [default = {}]".format(InkscapeExporterConfig.FRAGMENTS_DEFAULT))

        self.args = parser.parse_args()

        # Logging interface ====================================================

        if self.args.verbose:
            level = logging.DEBUG
        else:
            level = logging.INFO
        # Create the logger
        self.applogger = Inkscape2LaTeXLogger(level)
        # Use a shortcut variable
        LOGGER = self.applogger.logger

    def run(self):
        """Execute the command-line."""
        # Check user-input consistency
        if not path.exists(self.args.FILE):
            LOGGER.critical("{} not found!".format(self.args.FILE))
            sys.exit(1)
        if not path.splitext(self.args.FILE)[1] == ".svg":
            LOGGER.critical("{} not an SVG!".format(self.args.FILE))
            sys.exit(1)

        # Create the configuration for the exportation
        config = InkscapeExporterConfig(input_file=self.args.FILE)
        # By default, load from TOML if detected 
        config.load_toml()
        if self.args.verbose:
            LOGGER.debug(config)
        # Override with command-line parameters
        config.load_args(
            output_dir=self.args.output_dir,
            fonts_engine=self.args.fonts_engine,
            fragments=self.args.fragments
        )
        if self.args.verbose:
            LOGGER.debug(config)

        # Create and the exportation
        exporter = InkscapeExporter(config)
        exporter.run()

if __name__ == "__main__":
    inkscape2latexcli = Inkscape2LaTeXCLI()
    inkscape2latexcli.run()
