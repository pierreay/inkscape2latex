#!/usr/bin/env python

# Program: inkscape2latex-ng
# Author: Pierre Ayoub
# Date: 2025-09-13
# Template UUID: b4b9d863-051e-494d-a98b-22b9d0ee4727

from os import path
import sys
import argparse
import logging
import tomllib

LOGGER = None

class InkscapeExporterConfig():
    """Configuration for a `InkscapeExporter`.

    This can be configured from command-line or a sidecar TOML file on-disk.

    """
    # Constants ================================================================

    # Export all the area defining the page.
    INKSCAPE_OPT_AREA    = "--export-area-page"
    # Export in PDF rather than EPS.
    INKSCAPE_OPT_TYPE    = "--export-type=pdf"
    # Export in current working directroy by default.
    OUTPUT_DIR_DEFAULT   = "."
    # Let Inkscape render fonts by default.
    FONTS_ENGINE_DEFAULT = "inkscape"
    # By default, performs a full exportation instead of fragments
    FRAGMENTS_DEFAULT    = False

    # Runtime variables ========================================================

    # Input SVG file to export [string]
    input_file       = None
    # Output directory for exportation [string]
    output_dir = OUTPUT_DIR_DEFAULT

    # Common dictionary to command-line and TOML file.
    config_dict = {
        "params": {
            # Define which from Inkscape or LaTeX will render the fonts ["latex" | "inkscape"]
            "fonts_engine": FONTS_ENGINE_DEFAULT,
            # Flag enabling fragments exportation instead of full exportation [bool]
            "fragments": FRAGMENTS_DEFAULT,
        },
        # Defines series of fragments exportation
        # [{"name": "NAME", "excluded_id": ["step1", "step3", "step3"]}]
        "fragments": None,
    }

    # Methods ==================================================================

    def __init__(self, input_file):
        """Initialize an exporter configuration with an input file and default values."""
        # Get an input file
        self.input_file = input_file

    def load_toml(self):
        """Load a configuration from a sidecar TOML file."""
        # If found a corresponding TOML file, load it.
        config_file_name = self.input_file.replace(".svg", ".toml")
        if path.exists(config_file_name):
            LOGGER.debug("Loading configuration from: {}".format(config_file_name))
            with open(config_file_name, "rb") as f:
                config_file_content = tomllib.load(f)
        # Otherwise, silently ignore.
        else:
            return
        # Update object configuration from the TOML configuration
        self.config_dict.update(config_file_content)

    def load_args(self, output_dir=None, fonts_engine=None, fragments=None):
        """Load configuration from arguments. 

        Purpose is to configure manually for testing purpose or overriding after loading from a TOML file.

        """
        LOGGER.debug("Loading configuration from command-line")
        if output_dir is not None:
            self.output_dir = output_dir
        if fonts_engine is not None:
            self.config_dict["params"]["fonts_engine"] = fonts_engine
        if fragments is not None:
            self.config_dict["params"]["fragments"] = fragments

    def __str__(self):
        """Return a textual representation of the current configuration"""
        return "\n[v] input_file={}\n[v] output_dir={}\n[v] config_dict={}".format(
            self.input_file,
            self.output_dir,
            self.config_dict
        )


class InkscapeExporter():
    """Inkscape Exporter configurable through InkscapeExporterConfig."""
    def __init__(self):
        pass

class Inkscape2LaTeXLogger():
    """Logger for Inkscape2LaTeX."""

    FMT_INFO = "[%(levelname)s] %(name)s: %(message)s"
    FMT_DEBUG = "[%(levelname)s] %(name)s.%(module)s: %(message)s"

    def __init__(self, level):
        assert level in [logging.INFO, logging.DEBUG]
        # Create the logger
        self.logger = logging.getLogger('inkscape2latex')
        self.logger.setLevel(level)

        # Create console handler and set level to debug
        self.handler = logging.StreamHandler()
        self.handler.setLevel(level)

        # Create formatter
        if level == logging.INFO:
            fmt = Inkscape2LaTeXLogger.FMT_INFO
        elif level == logging.DEBUG:
            fmt = Inkscape2LaTeXLogger.FMT_DEBUG
        else:
            fmt = "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
        self.formatter = logging.Formatter(fmt)

        # Connect everything
        self.handler.setFormatter(self.formatter)
        self.logger.addHandler(self.handler)

class Inkscape2LaTeXCLI:
    """Command-line interface for Inkscape2LaTeX."""

    def __init__(self):
        """Initialize command-line interface."""
        global LOGGER

        # Command-line interface ===============================================

        parser = argparse.ArgumentParser(
            prog='inkscape2latex',
            description='TODO'
        )

        parser.add_argument('FILE', help="Inkscape drawing in SVG format to export", type=str)

        parser.add_argument('-v', '--verbose', default=False, action="store_true",
                            help="Increase verbosity if set")
        parser.add_argument("-o", "--output-dir", type=str, default=None,
                            help="Set the output directory [default = {}]".format(InkscapeExporterConfig.OUTPUT_DIR_DEFAULT))
        parser.add_argument("--fonts-engine", type=str, choices=["latex", "inkscape"], default=None,
                            help="Set the font rendering engine [default = {}]".format(InkscapeExporterConfig.FONTS_ENGINE_DEFAULT))
        parser.add_argument("--fragments", action="store_true", default=None,
                            help="Enable fragments exportation instead of full exportation")

        self.args = parser.parse_args()

        # Logging interface ====================================================

        if self.args.verbose:
            level = logging.DEBUG
        else:
            level = logging.INFO
        # Create the logger
        self.applogger = Inkscape2LaTeXLogger(level)
        # Use a shortcut variable
        LOGGER = self.applogger.logger

    def run(self):
        """Execute the command-line."""
        # Check user-input consistency
        if not path.exists(self.args.FILE):
            LOGGER.critical("{} not found!".Format(self.args.FILE))

        # Create the configuration for the exportation
        config = InkscapeExporterConfig(input_file=self.args.FILE)
        # By default, load from TOML if detected 
        config.load_toml()
        if self.args.verbose:
            LOGGER.debug(config)
        # Override with command-line parameters
        config.load_args(
            output_dir=self.args.output_dir,
            fonts_engine=self.args.fonts_engine,
            fragments=self.args.fragments
        )
        if self.args.verbose:
            LOGGER.debug(config)

        # Create and the exportation
        # TODO
        
if __name__ == "__main__":
    inkscape2latexcli = Inkscape2LaTeXCLI()
    inkscape2latexcli.run()
